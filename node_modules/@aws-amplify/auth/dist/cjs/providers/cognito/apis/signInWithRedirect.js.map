{"version":3,"file":"signInWithRedirect.js","sources":["../../../../../src/providers/cognito/apis/signInWithRedirect.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.parseRedirectURL = exports.oauthSignIn = exports.store = exports.signInWithRedirect = void 0;\nconst core_1 = require(\"@aws-amplify/core\");\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst cacheTokens_1 = require(\"../tokenProvider/cacheTokens\");\nconst tokenProvider_1 = require(\"../tokenProvider\");\nconst models_1 = require(\"../types/models\");\nconst signInWithRedirectStore_1 = require(\"../utils/signInWithRedirectStore\");\nconst AuthError_1 = require(\"../../../errors/AuthError\");\nconst Auth_1 = require(\"../../../types/Auth\");\nconst AuthErrorStrings_1 = require(\"../../../common/AuthErrorStrings\");\nconst Errors_1 = require(\"../../../Errors\");\nconst utils_2 = require(\"../../../utils\");\nconst signInHelpers_1 = require(\"../utils/signInHelpers\");\nconst oauth_1 = require(\"../utils/oauth\");\nconst getCurrentUser_1 = require(\"./getCurrentUser\");\nconst getRedirectUrl_1 = require(\"../utils/oauth/getRedirectUrl\");\n/**\n * Signs in a user with OAuth. Redirects the application to an Identity Provider.\n *\n * @param input - The SignInWithRedirectInput object, if empty it will redirect to Cognito HostedUI\n *\n * @throws AuthTokenConfigException - Thrown when the userpool config is invalid.\n * @throws OAuthNotConfigureException - Thrown when the oauth config is invalid.\n */\nasync function signInWithRedirect(input) {\n    const authConfig = core_1.Amplify.getConfig().Auth?.Cognito;\n    (0, utils_1.assertTokenProviderConfig)(authConfig);\n    (0, utils_1.assertOAuthConfig)(authConfig);\n    exports.store.setAuthConfig(authConfig);\n    await (0, signInHelpers_1.assertUserNotAuthenticated)();\n    let provider = 'COGNITO'; // Default\n    if (typeof input?.provider === 'string') {\n        provider = models_1.cognitoHostedUIIdentityProviderMap[input.provider];\n    }\n    else if (input?.provider?.custom) {\n        provider = input.provider.custom;\n    }\n    return oauthSignIn({\n        oauthConfig: authConfig.loginWith.oauth,\n        clientId: authConfig.userPoolClientId,\n        provider,\n        customState: input?.customState,\n        preferPrivateSession: input?.options?.preferPrivateSession,\n    });\n}\nexports.signInWithRedirect = signInWithRedirect;\nexports.store = new signInWithRedirectStore_1.DefaultOAuthStore(core_1.defaultStorage);\nasync function oauthSignIn({ oauthConfig, provider, clientId, customState, preferPrivateSession, }) {\n    const { domain, redirectSignIn, responseType, scopes } = oauthConfig;\n    const randomState = (0, oauth_1.generateState)();\n    /* encodeURIComponent is not URL safe, use urlSafeEncode instead. Cognito\n    single-encodes/decodes url on first sign in and double-encodes/decodes url\n    when user already signed in. Using encodeURIComponent, Base32, Base64 add\n    characters % or = which on further encoding becomes unsafe. '=' create issue\n    for parsing query params.\n    Refer: https://github.com/aws-amplify/amplify-js/issues/5218 */\n    const state = customState\n        ? `${randomState}-${(0, utils_1.urlSafeEncode)(customState)}`\n        : randomState;\n    const { value, method, toCodeChallenge } = (0, oauth_1.generateCodeVerifier)(128);\n    exports.store.storeOAuthInFlight(true);\n    exports.store.storeOAuthState(state);\n    exports.store.storePKCE(value);\n    const queryString = Object.entries({\n        redirect_uri: (0, getRedirectUrl_1.getRedirectUrl)(oauthConfig.redirectSignIn),\n        response_type: responseType,\n        client_id: clientId,\n        identity_provider: provider,\n        scope: scopes.join(' '),\n        state,\n        ...(responseType === 'code' && {\n            code_challenge: toCodeChallenge(),\n            code_challenge_method: method,\n        }),\n    })\n        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n        .join('&');\n    // TODO(v6): use URL object instead\n    const oAuthUrl = `https://${domain}/oauth2/authorize?${queryString}`;\n    const { type, error, url } = (await (0, utils_2.openAuthSession)(oAuthUrl, redirectSignIn, preferPrivateSession)) ??\n        {};\n    // This code will run in RN applications only as calling signInWithRedirect will\n    // resolve the promise.\n    if (type === 'success' && url) {\n        // ensure the code exchange completion resolves the signInWithRedirect\n        // returned promise in react-native\n        await handleAuthResponse({\n            currentUrl: url,\n            clientId,\n            domain,\n            redirectUri: redirectSignIn[0],\n            responseType,\n            userAgentValue: (0, utils_2.getAuthUserAgentValue)(utils_1.AuthAction.SignInWithRedirect),\n            preferPrivateSession,\n        });\n    }\n    // This code will run in RN applications only as calling signInWithRedirect will\n    // resolve the promise.\n    if (type === 'error') {\n        await handleFailure(String(error));\n    }\n}\nexports.oauthSignIn = oauthSignIn;\nasync function handleCodeFlow({ currentUrl, userAgentValue, clientId, redirectUri, domain, preferPrivateSession, }) {\n    /* Convert URL into an object with parameters as keys\n{ redirect_uri: 'http://localhost:3000/', response_type: 'code', ...} */\n    const url = new utils_1.AmplifyUrl(currentUrl);\n    let validatedState;\n    try {\n        validatedState = await validateState(getStateFromURL(url));\n    }\n    catch (err) {\n        invokeAndClearPromise();\n        // validateState method will always throw an AuthError when the state is not valid. The if statement is making TS happy.\n        if (err instanceof AuthError_1.AuthError) {\n            await handleFailure(err.message);\n        }\n        return;\n    }\n    const code = url.searchParams.get('code');\n    if (!code) {\n        await exports.store.clearOAuthData();\n        invokeAndClearPromise();\n        return;\n    }\n    const oAuthTokenEndpoint = 'https://' + domain + '/oauth2/token';\n    // TODO(v6): check hub events\n    // dispatchAuthEvent(\n    // \t'codeFlow',\n    // \t{},\n    // \t`Retrieving tokens from ${oAuthTokenEndpoint}`\n    // );\n    const codeVerifier = await exports.store.loadPKCE();\n    const oAuthTokenBody = {\n        grant_type: 'authorization_code',\n        code,\n        client_id: clientId,\n        redirect_uri: redirectUri,\n        ...(codeVerifier ? { code_verifier: codeVerifier } : {}),\n    };\n    const body = Object.entries(oAuthTokenBody)\n        .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`)\n        .join('&');\n    const { access_token, refresh_token, id_token, error, error_message, token_type, expires_in, } = await (await fetch(oAuthTokenEndpoint, {\n        method: 'POST',\n        headers: {\n            'Content-Type': 'application/x-www-form-urlencoded',\n            [utils_1.USER_AGENT_HEADER]: userAgentValue,\n        },\n        body,\n    })).json();\n    if (error) {\n        invokeAndClearPromise();\n        await handleFailure(error_message ?? error);\n    }\n    await exports.store.clearOAuthInflightData();\n    const username = (access_token && (0, utils_1.decodeJWT)(access_token).payload.username) ?? 'username';\n    await (0, cacheTokens_1.cacheCognitoTokens)({\n        username,\n        AccessToken: access_token,\n        IdToken: id_token,\n        RefreshToken: refresh_token,\n        TokenType: token_type,\n        ExpiresIn: expires_in,\n    });\n    return completeFlow({\n        redirectUri,\n        state: validatedState,\n        preferPrivateSession,\n    });\n}\nasync function handleImplicitFlow({ currentUrl, redirectUri, preferPrivateSession, }) {\n    // hash is `null` if `#` doesn't exist on URL\n    const url = new utils_1.AmplifyUrl(currentUrl);\n    const { id_token, access_token, state, token_type, expires_in, error_description, error, } = (url.hash ?? '#')\n        .substring(1) // Remove # from returned code\n        .split('&')\n        .map(pairings => pairings.split('='))\n        .reduce((accum, [k, v]) => ({ ...accum, [k]: v }), {\n        id_token: undefined,\n        access_token: undefined,\n        state: undefined,\n        token_type: undefined,\n        expires_in: undefined,\n        error_description: undefined,\n        error: undefined,\n    });\n    if (error) {\n        invokeAndClearPromise();\n        await handleFailure(error_description ?? error);\n    }\n    if (!access_token) {\n        await exports.store.clearOAuthData();\n        invokeAndClearPromise();\n        return;\n    }\n    let validatedState;\n    try {\n        validatedState = await validateState(state);\n    }\n    catch (error) {\n        invokeAndClearPromise();\n        // validateState method will always throw an AuthError when the state is not valid. The if statement is making TS happy.\n        if (error instanceof AuthError_1.AuthError) {\n            await handleFailure(error.message);\n        }\n        return;\n    }\n    const username = (access_token && (0, utils_1.decodeJWT)(access_token).payload.username) ?? 'username';\n    await (0, cacheTokens_1.cacheCognitoTokens)({\n        username,\n        AccessToken: access_token,\n        IdToken: id_token,\n        TokenType: token_type,\n        ExpiresIn: expires_in,\n    });\n    return completeFlow({\n        redirectUri,\n        state: validatedState,\n        preferPrivateSession,\n    });\n}\nasync function completeFlow({ redirectUri, state, preferPrivateSession, }) {\n    await exports.store.clearOAuthData();\n    await exports.store.storeOAuthSignIn(true, preferPrivateSession);\n    if (isCustomState(state)) {\n        core_1.Hub.dispatch('auth', {\n            event: 'customOAuthState',\n            data: (0, utils_1.urlSafeDecode)(getCustomState(state)),\n        }, 'Auth', utils_1.AMPLIFY_SYMBOL);\n    }\n    core_1.Hub.dispatch('auth', { event: 'signInWithRedirect' }, 'Auth', utils_1.AMPLIFY_SYMBOL);\n    core_1.Hub.dispatch('auth', { event: 'signedIn', data: await (0, getCurrentUser_1.getCurrentUser)() }, 'Auth', utils_1.AMPLIFY_SYMBOL);\n    clearHistory(redirectUri);\n    invokeAndClearPromise();\n}\nasync function handleAuthResponse({ currentUrl, userAgentValue, clientId, redirectUri, responseType, domain, preferPrivateSession, }) {\n    try {\n        const urlParams = new utils_1.AmplifyUrl(currentUrl);\n        const error = urlParams.searchParams.get('error');\n        const errorMessage = urlParams.searchParams.get('error_description');\n        if (error) {\n            await handleFailure(errorMessage);\n        }\n        if (responseType === 'code') {\n            return await handleCodeFlow({\n                currentUrl,\n                userAgentValue,\n                clientId,\n                redirectUri,\n                domain,\n                preferPrivateSession,\n            });\n        }\n        else {\n            return await handleImplicitFlow({\n                currentUrl,\n                redirectUri,\n                preferPrivateSession,\n            });\n        }\n    }\n    catch (e) {\n        throw e;\n    }\n}\nfunction getStateFromURL(urlParams) {\n    return urlParams.searchParams.get('state');\n}\nasync function validateState(state) {\n    const savedState = await exports.store.loadOAuthState();\n    // This is because savedState only exists if the flow was initiated by Amplify\n    const validatedState = state === savedState ? savedState : undefined;\n    if (!validatedState) {\n        throw new AuthError_1.AuthError({\n            name: Auth_1.AuthErrorTypes.OAuthSignInError,\n            message: 'An error occurred while validating the state',\n            recoverySuggestion: 'Try to initiate an OAuth flow from Amplify',\n        });\n    }\n    return validatedState;\n}\nasync function handleFailure(errorMessage) {\n    const error = new AuthError_1.AuthError({\n        message: errorMessage ?? 'An error has occurred during the oauth proccess',\n        name: AuthErrorStrings_1.AuthErrorCodes.OAuthSignInError,\n        recoverySuggestion: Errors_1.authErrorMessages.oauthSignInError.log,\n    });\n    await exports.store.clearOAuthInflightData();\n    core_1.Hub.dispatch('auth', { event: 'signInWithRedirect_failure', data: { error } }, 'Auth', utils_1.AMPLIFY_SYMBOL);\n    throw new AuthError_1.AuthError({\n        message: errorMessage ?? '',\n        name: AuthErrorStrings_1.AuthErrorCodes.OAuthSignInError,\n        recoverySuggestion: Errors_1.authErrorMessages.oauthSignInError.log,\n    });\n}\nasync function parseRedirectURL() {\n    const authConfig = core_1.Amplify.getConfig().Auth?.Cognito;\n    try {\n        (0, utils_1.assertTokenProviderConfig)(authConfig);\n        exports.store.setAuthConfig(authConfig);\n    }\n    catch (_err) {\n        // Token provider not configure nothing to do\n        return;\n    }\n    // No OAuth inflight doesnt need to parse the url\n    if (!(await exports.store.loadOAuthInFlight())) {\n        return;\n    }\n    try {\n        (0, utils_1.assertOAuthConfig)(authConfig);\n    }\n    catch (err) {\n        // TODO(v6): this should warn you have signInWithRedirect but is not configured\n        return;\n    }\n    try {\n        const currentUrl = window.location.href;\n        const { loginWith, userPoolClientId } = authConfig;\n        const { domain, redirectSignIn, responseType } = loginWith.oauth;\n        await handleAuthResponse({\n            currentUrl,\n            clientId: userPoolClientId,\n            domain,\n            redirectUri: redirectSignIn[0],\n            responseType,\n            userAgentValue: (0, utils_2.getAuthUserAgentValue)(utils_1.AuthAction.SignInWithRedirect),\n        });\n    }\n    catch (err) {\n        // is ok if there is not OAuthConfig\n    }\n}\nexports.parseRedirectURL = parseRedirectURL;\nfunction urlListener() {\n    // Listen configure to parse url\n    parseRedirectURL();\n    core_1.Hub.listen('core', capsule => {\n        if (capsule.payload.event === 'configure') {\n            parseRedirectURL();\n        }\n    });\n}\n(0, utils_1.isBrowser)() && urlListener();\n// This has a reference for listeners that requires to be notified, TokenOrchestrator use this for load tokens\nlet inflightPromiseResolvers = [];\nconst invokeAndClearPromise = () => {\n    for (const promiseResolver of inflightPromiseResolvers) {\n        promiseResolver();\n    }\n    inflightPromiseResolvers = [];\n};\n(0, utils_1.isBrowser)() &&\n    tokenProvider_1.cognitoUserPoolsTokenProvider.setWaitForInflightOAuth(() => new Promise(async (res, _rej) => {\n        if (!(await exports.store.loadOAuthInFlight())) {\n            res();\n        }\n        else {\n            inflightPromiseResolvers.push(res);\n        }\n        return;\n    }));\nfunction clearHistory(redirectUri) {\n    if (typeof window !== 'undefined' && typeof window.history !== 'undefined') {\n        window.history.replaceState({}, '', redirectUri);\n    }\n}\nfunction isCustomState(state) {\n    return /-/.test(state);\n}\nfunction getCustomState(state) {\n    return state.split('-').splice(1).join('-');\n}\n"],"names":[],"mappings":"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"}